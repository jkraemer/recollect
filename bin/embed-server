#!/usr/bin/env python3
"""Persistent embedding server for Recollect.

Reads JSON-lines from stdin, writes JSON-lines to stdout.
Model is loaded once on startup and kept warm.
"""
import sys
import json
import signal
from sentence_transformers import SentenceTransformer

MODEL_NAME = "sentence-transformers/all-MiniLM-L6-v2"
DIMENSIONS = 384


def main():
    sys.stderr.write(f"Loading model {MODEL_NAME}...\n")
    sys.stderr.flush()
    model = SentenceTransformer(MODEL_NAME)
    sys.stderr.write("Ready for requests.\n")
    sys.stderr.flush()

    def shutdown(signum, frame):
        sys.exit(0)

    signal.signal(signal.SIGTERM, shutdown)
    signal.signal(signal.SIGINT, shutdown)

    for line in sys.stdin:
        line = line.strip()
        if not line:
            continue

        try:
            request = json.loads(line)
        except json.JSONDecodeError as e:
            sys.stdout.write(json.dumps({"error": f"Invalid JSON: {e}"}) + "\n")
            sys.stdout.flush()
            continue

        if request.get("ping"):
            sys.stdout.write(json.dumps({"pong": True}) + "\n")
            sys.stdout.flush()
            continue

        texts = request.get("texts", [])
        if not texts:
            response = {"embeddings": [], "dimensions": DIMENSIONS}
        else:
            embeddings = model.encode(texts, normalize_embeddings=True)
            response = {
                "embeddings": [emb.tolist() for emb in embeddings],
                "dimensions": DIMENSIONS
            }

        sys.stdout.write(json.dumps(response) + "\n")
        sys.stdout.flush()


if __name__ == "__main__":
    main()
